{% extends 'admin/home.html' %}
{% load static %}
{% block title %}Update Exchange Request{% endblock %}
{% block content %}
<script src="{% static 'js/admin/exchange_request/exchange_update.js' %}"></script>
<div class="card shadow-sm m-auto mt-4 p-4 rounded" style="max-width: 600px;">
    <h2 class="mb-4 text-center fw-bold" style="color: #007bff;">Update Exchange Request</h2>
    <form class="px-3" id="adminExchangeForm" onsubmit="return false;" novalidate>

        <input id="exchange_id" value="{{ exchange.id }}" hidden>
        
        <div class="mb-3">
            <label for="order" class="form-label fw-semibold">Order*</label>
            <select id="order" name="order" class="form-select" required>
                {% for order in orders %}
                <option value="{{ order.id }}" {% if order.id == exchange.order.id %}selected{% endif %}>
                    {{ order.id }} - {{ order.user.username }} (â‚¹{{ order.total_price }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="user" class="form-label fw-semibold">User*</label>
            <select id="user" name="user" class="form-select" required>
                {% for user in users %}
                <option value="{{ user.id }}" {% if user.id == exchange.user.id %}selected{% endif %}>
                    {{ user.username }} ({{ user.email }})
                </option>
                {% endfor %}
            </select>
        </div>


        <div class="mb-3">
            <label for="reason" class="form-label fw-semibold">Reason*</label>
            <textarea id="reason" name="reason" class="form-control" style="border-radius: 6px;" required>{{ exchange.reason }}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Current Status: {{ exchange.get_status_display }}</label>
            <small class="text-muted">Request Date: {{ exchange.request_date|date:"M d, Y H:i" }}</small>
            {% if exchange.processed_date %}
            <br><small class="text-muted">Processed: {{ exchange.processed_date|date:"M d, Y H:i" }}</small>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="status" class="form-label fw-semibold">Status*</label>
            <select id="status" name="status" class="form-select" required>
                {% for enum in enums %}
                <option value="{{enum.value}}" {% if exchange.status == enum.value %}selected{% endif %}>{{enum.name}}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="purpose" class="form-label fw-semibold">Purpose*</label>
            <select id="purpose" name="purpose" class="form-select" required>
                <option value="1" {% if exchange.purpose == 1 %}selected{% endif %}>Exchange</option>
                <option value="2" {% if exchange.purpose == 2 %}selected{% endif %}>Return</option>
            </select>
        </div>

        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if exchange.is_active %}checked{% endif %}>
            <label class="form-check-label fw-semibold" for="is_active">Active</label>
        </div>

        <button type="submit" onclick="exchange_update()" class="btn btn-primary fw-bold mt-3 w-100" style="padding: 12px; font-size: 18px; border-radius: 8px;">
            Update Exchange Request
        </button>
    </form>

    <div id="message" class="text-center mt-4 fw-semibold m-auto"></div>
</div>

<script>
    // Dynamic order item population on order change
    document.getElementById('order').addEventListener('change', function() {
        const orderId = this.value;
        const orderItemSelect = document.getElementById('order_item');
        orderItemSelect.innerHTML = '<option value="">Select Order Item</option>';
        
        if (orderId) {
            fetch(`/admin/exchange/get-order-items/${orderId}/`)
                .then(response => response.json())
                .then(items => {
                    items.forEach(item => {
                        orderItemSelect.innerHTML += `<option value="${item.id}">${item.id} - ${item.product_name} (Qty: ${item.quantity})</option>`;
                    });
                })
                .catch(error => console.error('Error:', error));
        }
    });





    async function exchange_update() {
        // Get form elements
        const form = document.getElementById('adminExchangeForm');
        const messageDiv = document.getElementById('message');
        const submitBtn = form.querySelector('button[type="submit"]');
        
        // Show loading state
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
        submitBtn.disabled = true;
        messageDiv.innerHTML = '';
        
        try {
            // Collect form data
            const formData = new FormData(form);
            
            // Convert checkbox to proper boolean value
            const isActiveCheckbox = document.getElementById('is_active');
            formData.set('is_active', isActiveCheckbox.checked.toString());
            
            // Send POST request
            const response = await fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'), // Django CSRF protection
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Success - show message and redirect
                messageDiv.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        ${data.message || 'Exchange request updated successfully!'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // Redirect after 1.5 seconds
                setTimeout(() => {
                    window.location.href = '/admin/exchange-requests/';
                }, 1500);
                
            } else {
                // Error response
                throw new Error(data.error || 'Something went wrong!');
            }
            
        } catch (error) {
            // Network or other errors
            messageDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Error: ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        } finally {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // Helper function to get CSRF token (required for Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

</script>

<style>
    #message.error {
        margin: 20px auto;
        color: #dc3545;
    }
    #message.success {
        margin: 20px auto;
        color: #28a745;
    }
</style>
{% endblock %}
