{% extends 'delivery/base.html'%}
{% load static %}
{% block title %} Home | Delivery Site {% endblock %}

{% block content %}
<div class="container-9 py-4 px-4" style="min-height: 100vh; background:white;">
  <!-- Stats cards -->
  <div class="row mb-5 d-flex justify-content-center">
    <div class="col-md-3 bar-card-col col-sm-5 d-flex justify-content-center mb-3">
      <div class="card shadow-sm">
        <div class="bar-txt card-body">
          <h5 class="text-center card-title mb-2">Request For Delivery</h5>
          <h3 id="totalDeliveries" class="text-center mb-0">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 bar-card-col col-sm-5 d-flex justify-content-center mb-3">
      <div class="card shadow-sm">
        <div class="bar-txt card-body">
          <h5 class="text-center card-title mb-2">Total Deliveries</h5>
          <h3 id="totalDeliveries" class="text-center mb-0">0</h3>
        </div>
      </div>
    </div>
    
    <div class="col-md-3 bar-card-col col-sm-5 d-flex justify-content-center mb-3">
      <div class="card shadow-sm">
        <div class="bar-txt card-body">
          <h5 class="text-center card-title mb-2">Total Pickups</h5>
          <h3 id="totalPickups" class="text-center mb-0">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 bar-card-col col-sm-5 d-flex justify-content-center mb-3">
      <div class="card shadow-sm">
        <div class="bar-txt card-body">
          <h5 class="text-center card-title mb-2">Completion Rate</h5>
          <h3 id="completionRate" class=" text-center mb-0">0%</h3>
        </div>
      </div>
    </div>
  </div>
<div class="d-flex align-items-conter justify-content-center">
  <!-- Bar chart -->
  <div class="card shadow-sm" style="max-width:1000px!important;">
    <div class="card-body">
      <h5 class="card-title mb-3">Deliveries vs Pickups (Last 7 Days)</h5>
      <canvas id="deliveryPickupChart" style="width:100%; max-height:400px;"></canvas>
    </div>
  </div>
</div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>

<script>
  const chartData = JSON.parse('{{ chart_data|safe }}');
  const labels = chartData.labels;
  const deliveries = chartData.deliveries;
  const pickups    = chartData.pickups;

  // Update KPI cards
  const totalDeliveries = deliveries.reduce((a, b) => a + b, 0);
  const totalPickups    = pickups.reduce((a, b) => a + b, 0);
  const totalJobs       = totalDeliveries + totalPickups;
  const completionRate  = totalJobs === 0 ? 0 : Math.round((totalDeliveries / totalJobs) * 100);

  document.getElementById("totalDeliveries").innerText = totalDeliveries;
  document.getElementById("totalPickups").innerText    = totalPickups;
  document.getElementById("completionRate").innerText  = completionRate + "%";

  // Bar chart config
  const ctx = document.getElementById("deliveryPickupChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Deliveries",
          data: deliveries,
          backgroundColor: "rgba(54, 162, 235, 0.7)",
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 1
        },
        {
          label: "Pickups",
          data: pickups,
          backgroundColor: "rgba(255, 159, 64, 0.7)",
          borderColor: "rgba(255, 159, 64, 1)",
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          stacked: false
        },
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      },
      plugins: {
        legend: {
          position: "top"
        },
        tooltip: {
          enabled: true
        }
      }
    }
  });
</script>
<style>
  .card{
    padding:0.5rem;
  }
  @media(max-width:1200px){
    .bar-txt h5{
      font-size: 80%;
    }
    .bar-txt h3{
      font-size: 80%;
    }
    .card{
    padding:0.2rem;
  }
  }
  @media(max-width:576px){
    .bar-card-col{
      width:50%;
    }
  }
</style>
{% endblock %}
