{% extends 'enduser/base.html'%}
{% load static %} 
{% block title %}Payment|GroceryGo{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/enduser/singly_order_summary.css'%}"/>
{% endblock %}
{% block content %}
    <style>
        .payment-card {
            border:1px solid gray;
            border-radius: 14px;
            padding: 2rem;
            margin-top: 40px;
        }
        .method-form {
            display: none;
            margin-top: 20px;
            animation: fade .3s ease-in-out;
        }
        @keyframes fade {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        .upi-badge {
            font-size: 2rem;
        }

        @media(max-width:400px){
          .modalcontent{
            margin:auto 20px!important;
          }
        }
    </style>

<!-- Modal: Hidden by default -->
<div id="back-modal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(10,12,30,0.36); align-items:center; justify-content:center;">
 <div class="modalcontent" style="min-width:280px; top:30%; max-width:350px; margin:auto; background:#fff; border-radius:12px; box-shadow:0 2px 24px rgba(30,30,140,.10); padding:2rem; position:relative;">
  <p class="text-center fs-sm mb-3" id="remove-modal-msg">
   <h3 class="text-center">Do you cancel payment? </h3>
   <p class="text-center">If you cancel the payment then your order will be discarded.</p>
  </p>
  <div class="d-flex gap-3 justify-content-center">
   <button id="modal-remove-btn" class="btn btn-danger px-3">No</button>
   <button id="modal-cancel-btn" onclick="delete_order({{order.id}})" class="btn btn-secondary px-3">I want to Cancel</button>
  </div>
 </div>
</div>


<div class="container-9 py-4 px-4">
    <!-- Header Section -->
    <div class="order-header mt-2 mb-2">
      <div class="header-content">
        <div class="header-icon">
            <i class="bi bi-credit-card"></i>
        </div>
        <h1 class="order-title">Make Payment </h1>
        <p class="order-subtitle">Choose the payment method and proceed to place your order </p>
      </div>
      <div class="progress-bar"style="flex-direction:row;">
        <div class="progress-step active">
          <i class="bi bi-box-seam"></i>
          <span>Choose Product</span>
        </div>
        <div class="progress-line active"></div>
        <div class="progress-step active">
          <i class="bi bi-clipboard-check"></i>
          <span>Chooose Details</span>
        </div>
        <div class="progress-line active"></div>
        <div class="progress-step active">
          <i class="bi bi-credit-card"></i>
          <span>Payment</span>
        </div>
      </div>
    </div>
    <div class="payment-card col-lg-6 col-md-8 col-sm-12 mx-auto">

        <h3 class="text-center mb-3">
            <i class="bi bi-wallet2 me-2"></i>Create Payment
        </h3>
        <p class="text-center text-muted mb-4">Select a payment method and fill in required details.</p>

        <div class="mb-3">
            <label class="form-label fw-semibold">Amount</label>
            <input type="text" class="form-control" id="amount" name="amount" value = "{{order.total_price}}" disabled>
        </div>
        <!-- Payment Method Select -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Select Payment Method</label>
            <select class="form-select" id="payment-method">
                <option value="">-- Choose Option --</option>
                <option value="UPI">UPI</option>
                <option value="CREDITCARD">Credit Card</option>
                <option value="DEBITCARD">Debit Card</option>
                <option value="NETBANKING">Net Banking</option>
                <option value="COD">Cash on Delivery (COD)</option>
            </select>
        </div>

        <!-- ======================= FORMS ======================= -->

        <!-- UPI Form -->
        <div id="UPI-form" class="method-form">
            <h5 class="fw-bold mb-3">UPI Payment</h5>
            <div class="mb-3">
                <label class="form-label">Enter UPI ID</label>
                <input type="text" class="form-control" placeholder="example@upi">
            </div>
            <button class="btn btn-primary w-100">Pay via UPI</button>
        </div>

        <!-- Credit Card Form -->
        <div id="CREDITCARD-form" class="method-form">
            <h5 class="fw-bold mb-3">Credit Card Details</h5>

            <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input type="text" class="form-control" placeholder="XXXX-XXXX-XXXX-XXXX">
            </div>
            <div class="row mb-3">
                <div class="col-6">
                    <label class="form-label">Expiry Date</label>
                    <input type="text" class="form-control" placeholder="MM/YY">
                </div>
                <div class="col-6">
                    <label class="form-label">CVV</label>
                    <input type="password" class="form-control" placeholder="***">
                </div>
            </div>
            <button class="btn btn-success w-100">Pay via Credit Card</button>
        </div>

        <!-- Debit Card Form -->
        <div id="DEBITCARD-form" class="method-form">
            <h5 class="fw-bold mb-3">Debit Card Details</h5>

            <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input type="text" class="form-control" placeholder="XXXX-XXXX-XXXX-XXXX">
            </div>

            <div class="row mb-3">
                <div class="col-6">
                    <label class="form-label">Expiry Date</label>
                    <input type="text" class="form-control" placeholder="MM/YY">
                </div>
                <div class="col-6">
                    <label class="form-label">CVV</label>
                    <input type="password" class="form-control" placeholder="***">
                </div>
            </div>

            <button class="btn btn-info w-100">Pay via Debit Card</button>
        </div>

        <!-- Net Banking -->
        <div id="NETBANKING-form" class="method-form">
            <h5 class="fw-bold mb-3">Net Banking</h5>

            <div class="mb-3">
                <label class="form-label">Select Your Bank</label>
                <select class="form-select">
                    <option value="">-- Choose Bank --</option>
                    <option>SBI</option>
                    <option>HDFC Bank</option>
                    <option>Axis Bank</option>
                    <option>ICICI Bank</option>
                </select>
            </div>
            <button class="btn btn-warning w-100">Proceed to Net Banking</button>
        </div>

        <!-- COD -->
        <div id="COD-form" class="method-form">
            <h5 class="fw-bold mb-2">Cash on Delivery</h5>
            <p class="text-muted small">
                You can pay in cash when your order is delivered at your doorstep.
            </p>
            <button class="btn btn-dark w-100">Place Order (COD)</button>
        </div>
        <button type="button" onclick="open_modal()" class="btn btn-secondary w-100 mt-4">Back</button>
    </div>
    <div class="trust-section mt-5">
      <div class="row g-3">
        <div class="col-6 col-md-3">
          <div class="trust-item">
            <i class="bi bi-shield-check"></i>
            <span>Secure Payment</span>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="trust-item">
            <i class="bi bi-truck"></i>
            <span>Fast Delivery</span>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="trust-item">
            <i class="bi bi-arrow-repeat"></i>
            <span>Easy Returns</span>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="trust-item">
            <i class="bi bi-headset"></i>
            <span>24/7 Support</span>
          </div>
        </div>
      </div>
    </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- JS to Toggle Payment Forms -->
<script>
  function delete_order(orderId) {
    document.getElementById('back-modal').style.display = 'none';
    document.getElementById('loaderdiv').style.display = 'block';
      fetch(`/delete/order/${orderId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ orderId })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok.');
        }
        return response.json();
      })
      .then(data => {
        console.log('Order deleted:', data);
        setTimeout(() => {
          document.getElementById('loaderdiv').style.display = 'none';
          window.location.href = '/';
        }, 1000);
      })
      .catch(error => {
        console.error('Error deleting order:', error);
        document.getElementById('loaderdiv').style.display = 'none';
      });
  }



  function open_modal(){
    const modal = document.getElementById('back-modal').style.display = 'block';
  }
  function close_modal(){
    document.getElementById('back-modal').style.display = 'none';
  }

    document.getElementById('payment-method').addEventListener('change', function () {
        const method = this.value;

        document.querySelectorAll('.method-form').forEach(form => form.style.display = 'none');

        if (method) {
            const selectedForm = document.getElementById(method + '-form');
            if (selectedForm) selectedForm.style.display = 'block';
        }
    });

    // Payment Submission Handler
    document.addEventListener("DOMContentLoaded", function () {
        // Define mapping between payment method and related form elements
        const methodConfigs = {
            UPI: {
                buttonSelector: "#UPI-form button",
                data: function() {
                    return {
                        method: "UPI",
                        upi_id: document.querySelector("#UPI-form input[type='text']").value
                    }
                }
            },
            CREDITCARD: {
                buttonSelector: "#CREDITCARD-form button",
                data: function() {
                    const inputs = document.querySelectorAll("#CREDITCARD-form input");
                    return {
                        method: "CREDITCARD",
                        card_number: inputs[0].value,
                        expiry: inputs[1].value,
                        cvv: inputs[2].value
                    }
                }
            },
            DEBITCARD: {
                buttonSelector: "#DEBITCARD-form button",
                data: function() {
                    const inputs = document.querySelectorAll("#DEBITCARD-form input");
                    return {
                        method: "DEBITCARD",
                        card_number: inputs[0].value,
                        expiry: inputs[1].value,
                        cvv: inputs[2].value
                    }
                }
            },
            NETBANKING: {
                buttonSelector: "#NETBANKING-form button",
                data: function() {
                    return {
                        method: "NETBANKING",
                        bank: document.querySelector("#NETBANKING-form select").value
                    }
                }
            },
            COD: {
                buttonSelector: "#COD-form button",
                data: function() {
                    return { method: "COD" }
                }
            }
        };

        // Attach event listeners for all method buttons
        Object.keys(methodConfigs).forEach(function(method) {
            const selector = methodConfigs[method].buttonSelector;
            const button = document.querySelector(selector);
            if (button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    submitPayment(method);
                });
            }
        });

        function submitPayment(method) {
            // Construct payload
            let data = methodConfigs[method].data();
            data.amount = document.getElementById("amount").value;
            data.order_id = "{{order.id}}"; // Use Django template variable

            // Optionally show loader here
            document.getElementById('loaderdiv').style.display = 'block';
            setTimeout(()=>{
              fetch(`/create/payment/${data.order_id}/`, {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                  },
                  body: JSON.stringify(data)
              })
              .then(response => response.json())
              .then(result => {
                  if (result.success) {
                      document.getElementById('loaderdiv').style.display = 'none';
                      showMessage('success', "Payment successful! Redirecting...");
                      // Redirect after short delay if you want
                      setTimeout(() => {
                          window.location.href = result.redirect_url || '/order/success/';
                      }, 1000);
                  } else {
                      document.getElementById('loaderdiv').style.display = 'none';
                      showMessage('error',"Something went wrong.");
                  }
              })
              .catch(() => {
                  document.getElementById('loaderdiv').style.display = 'none';
                  showMessage('error', "Network or server error. Please try again.");
              })
            
            },1500);
        }     
    });

</script>

{% endblock %}
