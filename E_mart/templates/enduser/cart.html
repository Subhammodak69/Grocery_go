{% extends 'enduser/base.html' %}
{% load static %}
{% block title %} Cart | Grocery_Go {% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/enduser/cart.css' %}">
{% endblock %}
{% block extra_js %}
  <script src = "{% static 'js/enduser/cartitem_remove.js' %}"></script>
{% endblock %}
{% block content %}

<!-- Modal: Hidden by default -->
<div id="remove-modal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(10,12,30,0.36); align-items:center; justify-content:center;">
 <div style="max-width:350px; margin:auto; background:#fff; border-radius:12px; box-shadow:0 2px 24px rgba(30,30,140,.10); padding:2rem; position:relative;">
  <p class="text-center fs-sm mb-3" id="remove-modal-msg">
   Do you want to remove <span id="remove-item-name" style="font-weight:bold;"></span> from your cart?
  </p>
  <div class="d-flex gap-3 justify-content-center">
   <button id="modal-remove-btn" class="btn btn-danger px-3">Remove</button>
   <button id="modal-cancel-btn" class="btn btn-secondary px-3">Cancel</button>
  </div>
 </div>
</div>


<div class="cart-container">
  <div class="container-fluid px-3 px-md-4 py-4">
    
    <!-- Header Section -->
    <div class="cart-header mb-4">
      <h2 class="cart-title">
        <i class="bi bi-cart-check-fill me-2"></i>
        Your Shopping Cart
      </h2>
      <p class="cart-subtitle text-muted">
        {% if cart_data %}
          {{ cart_data|length }} item{{ cart_data|length|pluralize }} in your cart
        {% else %}
          Your cart is empty
        {% endif %}
      </p>
    </div>
<input type="hidden" id="cartId" value="{{cart_id}}">
    <div class="row g-3 g-lg-4">
      
      <!-- Product List Section -->
      <div class="col-12 col-lg-8">
        <div class="products-section">
          {% if cart_data %}
            <div class="products-scroll">
              {% for item in cart_data %}
              <div class="cart-item" data-item-id="{{ item.id }}" style="background: #475569;">
                
                <!-- Delete Button -->
                <button class="delete-btn bg-danger" aria-label="Remove item">
                  <i class="bi bi-trash3 text-white"></i>
                </button>

                <div class="cart-item-content">
                  
                  <!-- Product Image -->
                  <div class="product-image-wrapper">
                    <img 
                      src="{% static item.product_image %}" 
                      alt="{{ item.product_name }}"
                      class="product-image"
                      loading="lazy"
                    >
                  </div>

                  <!-- Product Details -->
                  <div class="product-details">
                    <h5 class="product-name">{{ item.product_name }}</h5>
                    <p class="product-description">{{ item.product_description }}</p>
                    
                    <!-- Quantity Controls -->
                    <div class="quantity-controls">
                      <button class="qty-btn qty-minus">
                        <i class="bi bi-dash"></i>
                      </button>
                      <span class="qty-display">{{ item.quantity }}</span>
                      <button class="qty-btn qty-plus">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Price Badge -->
                  <div class="price-wrapper">
                    <div class="price-badge">
                      ₹{{ item.product_price }}
                    </div>
                    <div class="item-total text-white small mt-2">
                      Total: ₹{{ item.item_total|floatformat:2 }}
                    </div>
                  </div>

                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-cart">
              <i class="bi bi-cart-x empty-cart-icon"></i>
              <h4 class="mt-3">Your cart is empty</h4>
              <p class="text-muted">Add items to get started!</p>
              <a href="{% url 'home' %}" class="btn btn-primary mt-3">
                <i class="bi bi-shop me-2"></i>Start Shopping
              </a>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Order Summary Section -->
      <div class="col-12 col-lg-4">
        <div class="summary-sticky">
          <div class="summary-card">
            
            <div class="summary-header">
              <h5 class="summary-title">
                <i class="bi bi-receipt me-2"></i>Order Summary
              </h5>
            </div>

            <div class="summary-body">
              
              <!-- Price Breakdown -->
              <div class="summary-row">
                <span class="summary-label">Subtotal</span>
                <span class="summary-value">₹{{ total_summary.total_price }}</span>
              </div>

              <div class="summary-row discount">
                <span class="summary-label">
                  <i class="bi bi-tag-fill me-1"></i>Discount
                </span>
                <span class="summary-value text-success">-₹{{ total_summary.discount|floatformat:2  }}</span>
              </div>

              <div class="summary-row">
                <span class="summary-label">Delivery Fee</span>
                {% if total_summary.total_price %}
                  <span class="summary-value">₹{{ total_summary.fee }}</span>
                {% endif %}
              </div>

              <div class="summary-divider"></div>

              <!-- Total -->
              <div class="summary-row total">
                <span class="summary-label">Total Amount</span>
                {% if total_summary.total_price %}
                <span class="summary-value">₹{{ final_price|floatformat:2  }}</span>
                {% endif %}
              </div>

              <!-- Savings Badge -->
              {% if total_summary.discount > 0 %}
              <div class="savings-badge">
                <i class="bi bi-piggy-bank me-2"></i>
                You're saving ₹{{ total_summary.discount|floatformat:2  }}!
              </div>
              {% endif %}

            </div>

            <!-- Checkout Button -->
            <div class="summary-footer">
              <button class="btn-checkout" {% if not cart_data %}disabled{% endif %} onclick="window.location.href='/cart-product-order/summary/'">
                <span class="checkout-text">Proceed to Checkout</span>
                <i class="bi bi-arrow-right ms-2"></i>
              </button>
            </div>

          </div>

          <!-- Trust Badges -->
          <div class="trust-badges mt-3">
            <div class="trust-item">
              <i class="bi bi-shield-check"></i>
              <span>Secure Payment</span>
            </div>
            <div class="trust-item">
              <i class="bi bi-truck"></i>
              <span>Free Delivery</span>
            </div>
            <div class="trust-item">
              <i class="bi bi-arrow-repeat"></i>
              <span>Easy Returns</span>
            </div>
          </div>

        </div>
      </div>

    </div>

    {% if cart_data %}
    <!-- Continue Shopping Footer -->
    <div class="cart-footer">
      <button class="continue-shopping-btn" onclick="go_back()">
      <i class="bi bi-arrow-left me-2"></i>

      Continue Shopping
      </button>

    </div>
    {% endif %}

  </div>
</div>


<script>
  function go_back() {
    window.history.back();
  }

  // Quantity controls (add your AJAX logic here)
  document.querySelectorAll('.cart-item').forEach(itemElem => {
    const itemId = itemElem.getAttribute('data-item-id');
    // Elements
    const qtyMinusBtn = itemElem.querySelector('.qty-minus');
    const qtyPlusBtn = itemElem.querySelector('.qty-plus');
    const qtyDisplay = itemElem.querySelector('.qty-display');
    const itemTotalElem = itemElem.querySelector('.item-total');
    const priceBadge = itemElem.querySelector('.price-badge');

    qtyMinusBtn.addEventListener('click', function () {
      let qty = parseInt(qtyDisplay.textContent);
      if (qty > 1) {
        const newQty = qty - 1;
        updateQuantity(itemId, newQty, qtyDisplay, itemTotalElem, priceBadge);
      }
    });

    qtyPlusBtn.addEventListener('click', function () {
      let qty = parseInt(qtyDisplay.textContent);
      const newQty = qty + 1;
      updateQuantity(itemId, newQty, qtyDisplay, itemTotalElem, priceBadge);
    });
  });

  // API update function
  async function updateQuantity(itemId, newQty, qtyDisplay, itemTotalElem, priceBadge) {
    console.log('item_id=> '+itemId );

    try {
      const response = await fetch(`/api/product-quantity/update/${itemId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          quantity: newQty
        }),
      });
      if (response.ok) {
        const data = await response.json();
        qtyDisplay.textContent = data.quantity;
        itemTotalElem.textContent = "Total: ₹" + Number(data.item_total).toFixed(2);
        // Also update summary fields
        updateSummaryFields(data.cart_summary,data.final_price);
      } else {
        alert('Could not update quantity.');
      }
    } catch (err) {
      alert('Error updating cart.');
    }
  }

  function updateSummaryFields(summary,final_price) {
    document.querySelector('.summary-value').textContent = "₹" + Number(summary.total_price).toFixed(2);
    document.querySelector('.summary-row.discount .summary-value').textContent = "-₹" + Number(summary.discount).toFixed(2);
    document.querySelectorAll('.summary-row')[2].querySelector('.summary-value').textContent = "₹" + Number(summary.fee).toFixed(2);
    // Update total
    document.querySelector('.summary-row.total .summary-value').textContent = "₹" + Number(final_price).toFixed(2);
  }

</script>


{% endblock %}
