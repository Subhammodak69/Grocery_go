{% extends 'enduser/base.html' %}
{% load static %}
{% block title %} Product Details | Grocery_Go {% endblock %}
{% block content %}
<script src="{% static 'js/enduser/product_details.js' %}"></script>
<div class="container bg-white rounded shadow p-4" style="margin-top:80px;">
  <div class="row g-4">
    <!-- Product Image -->
    <div class="col-12 col-md-6">
        <span id="wishlist-{{ product.id }}" class="icon-love"
            data-product-id="{{ product.id }}" 
            onclick="toggleWishlist(this)">
            {% if product.is_in_wishlist %}
            <i class="bi bi-heart-fill" style="color:red"></i>
            {% else %}
            <i class="bi bi-heart"></i>
            {% endif %}
        </span>

        <img src="{% static product.image %}" alt="Product Image" class="img-fluid rounded" style="border:1px solid grey; border-radius:5px; padding: 40px 20px;"/>
        </div>

    <!-- Product Details -->
    <div class="col-12 col-md-6 d-flex flex-column justify-content-between">
      <div>
        <input type="hidden" id="product_id" value="{{product.id}}">
        <h1 class="h3 fw-bold mb-3 text-dark">{{product.name}}</h1>
        <p class="h4 fw-semibold text-primary mb-3">₹{{product.price}}/{{product.size}}</p>
        <div class="d-flex align-items-center mb-3">
          <div class="text-warning d-flex">
            <!-- 5 star icons for rating (Bootstrap doesn't have built-in SVG, so using inline SVG as is) -->
            <svg class="me-1" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
            </svg>
            <svg class="me-1" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
            </svg>
            <svg class="me-1" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
            </svg>
            <svg class="me-1" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
            </svg>
            <svg width="20" height="20" fill="#d1d5db" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
            </svg>
          </div>
          <span class="ms-2 text-muted small">(45 reviews)</span>
        </div>
        <p class="text-secondary mb-4">
            {{product.description}}
        </p>
        <h6>Category:</h6>
        <p class="mb-4">
            {{product.category.name}}
        </p>
        <p class="text-secondary mb-4">
            {{product.category.description}}
        </p>
        {% if product.stock == 0%}
        <p class="text-danger fw-semibold mb-4">Out of Stock</p>
        {% elif product.stock <= 50%}
        <p class="text-warning fw-semibold mb-4">Hurry up {{product.stock}} in Stock</p>
        {% else %}
        <p class="text-success fw-semibold mb-4">In Stock</p>
        {% endif %}
      </div>
      <div class="bg-gray-200" style="display: flex; align-items: center;border:2px solid gray; width:30%;border-radius:5px;">
        <button type="button" onclick="changeQuantity(-1)" style="font-size:20px;border: none;">-</button>
        <input 
            type="number" 
            id="quantity" 
            min="1" 
            max="{{product.stock}}" 
            value="1" 
            class="form-control text-center" 
            style="border:none;" 
            readonly
        />
        <button type="button" onclick="changeQuantity(1)" style="font-size:20px;border: none;">+</button>
    </div>
        <div class="mt-4 d-flex align-items-center gap-4">
            <button class="btn btn-danger px-4"onclick="buy_now()">
              <i class="bi bi-bag"></i> Buy now
            </button>
            <button class="btn btn-warning px-4" onclick="add_to_cart()">
              <i class="bi bi-cart"></i>Add to Cart
            </button>
        </div>
    </div>
  </div>

  <div class="mt-5 pt-4 border-top">
    <h2 class="h5 fw-semibold mb-3">Additional Information</h2>
    <ul class="list-unstyled text-secondary mb-0">
      <li>Delivery charges: Free shipping on orders over ₹500</li>
      <li>Discount: 4% off over ₹500 ,5% off over ₹1000 and 7% off over ₹3000 </li>
      <li>Exchange and Refund is available.</li>
    </ul>
  </div>
  <div class="mt-5 pt-4 border-top">
    <!-- Ratings & Reviews -->
      <div class="mt-4">
        <div class="d-flex justify-content-between">
          <h4>Reviews</h4>
          <button class="btn btn-primary" onclick="openreviewmodal()">Give your's Reviews</button>
        </div>

        <!-- Review Modal -->
        <div class="review-modal" id="reviewModal" style="display:none;">
          <div>
            <form id="reviewForm" onsubmit="event.preventDefault(); create_review();">
              <input type="hidden" id="product_id" value="{{ product_item_data.product_id }}" />

              <div id="starRating">
                <span class="star" data-value="1">&#9733;</span>
                <span class="star" data-value="1">&#9733;</span>
                <span class="star" data-value="1">&#9733;</span>
                <span class="star" data-value="1">&#9733;</span>
                <span class="star" data-value="1">&#9733;</span>
              </div>
              <input type="hidden" id="rating" name="rating" />

              <div class="px-2">
                <div class="d-flex justify-content-between" style="position: relative;">
                  <textarea id="review" style="border:none; background:rgb(206, 206, 206); padding:10px; width:100%;" placeholder="Write your review" required></textarea>

                  <!-- Hidden file input to select photo -->
                  <input type="file" id="photoInput" accept="image/*" style="display:none;" />

                  <!-- Photo icon - click triggers file input -->
                  <i id="photoIcon" style="right: 10px; bottom: 22%; position: absolute; font-size: 20px; cursor: pointer;" class="bi-card-image"></i>
                </div>

                <!-- Preview container -->
                <div id="photoPreviewContainer" style="margin-top: 10px; display:none;">
                  <img id="photoPreview" src="" alt="Photo Preview" style="max-width: 100%; max-height: 70px; border-radius: 4px;" />
                </div>

                <button class="btn btn-primary mt-2" type="submit">Submit Review</button>
              </div>
            </form>
          </div>
        </div>
          <hr>

        <!-- Reviews List -->
        {% if ratings %}
          <div class="reviews-container space-y-4">
            <div id="reviews-show"></div>
            {% for rating in ratings %}
              <div>
                <div class="d-flex justify-content-between items-center justify-between">
                  <div class=" d-flex gap-2 font-bold">
                    <p style="font-weight: bold; margin:0px!important;">
                    {{ rating.created_by_fullname|default:"Anonymous" }}
                    </p>
                    <div>
                  {{ rating.created_at|date:"M d, Y H:i" }}
                    </div>
                  </div>
                {% for i in rating.rating_range %}
          ⭐
        {% endfor %}
        {% for i in rating.empty_range %}
          ☆
        {% endfor %}

          </div>
          <p class="text-gray-700 mb-2 m-auto" style="width:96%;">{{ rating.review }}</p>
          {% if rating.photo %}
            <img src="{{ rating.photo }}" alt="Review photo" class="max-w-xs rounded-md mb-2 shadow" />
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-red-600 font-semibold">No reviews found yet.</p>
  {% endif %}
  </div>
</div>
<style>
.icon-love{
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: aliceblue;
    padding: 10px;
    justify-content: center;
    align-items: center;
    display: flex;
    font-size: 25px;
    margin-top: 10px;
    margin-left: 10px;
    position: absolute;
    }
input:focus, textarea:focus, select:focus {
  outline: none;
  box-shadow: none!important;
}
</style>
<script>
  function changeQuantity(delta) {
      const input = document.getElementById('quantity');
      let currentValue = parseInt(input.value, 10);
      const maxStock = {{product.stock}};
      const minValue = 1;

      let newValue = currentValue + delta;
      if (newValue > maxStock) newValue = maxStock;
      if (newValue < minValue) newValue = minValue;

      input.value = newValue;
  }











  // Open review modal function
  function openreviewmodal() {
    document.getElementById('reviewModal').style.display = 'block';
  }

  // Star rating toggle & sum logic
  const stars = document.querySelectorAll('#starRating .star');
  const ratingInput = document.getElementById('rating');

  stars.forEach(star => {
    star.addEventListener('click', () => {
      star.classList.toggle('selected');
      updateRating();
    });
  });

  function updateRating() {
    let total = 0;
    stars.forEach(star => {
      if (star.classList.contains('selected')) {
        total += parseInt(star.getAttribute('data-value'));
      }
    });
    ratingInput.value = total;
    console.log('Current total rating:', total);
  }

  // Photo upload & preview
  const photoIcon = document.getElementById('photoIcon');
  const photoInput = document.getElementById('photoInput');
  const photoPreviewContainer = document.getElementById('photoPreviewContainer');
  const photoPreview = document.getElementById('photoPreview');

  photoIcon.addEventListener('click', () => {
    photoInput.click();
  });

  photoInput.addEventListener('change', () => {
    const file = photoInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        photoPreview.src = e.target.result;
        photoPreviewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      photoPreview.src = '';
      photoPreviewContainer.style.display = 'none';
    }
  });

  

  // Submit review via AJAX with photo base64
  function create_review() {
    const csrftoken = getCookie('csrftoken');

    const product_id = document.getElementById('product_id').value;
    const rating = document.getElementById('rating').value;
    const review = document.getElementById('review').value;

    if (photoInput.files.length > 0) {
      const file = photoInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const photo_url = e.target.result;
        sendReviewData(product_id, photo_url, rating, review, csrftoken);
      };
      reader.readAsDataURL(file);
    } else {
      sendReviewData(product_id, '', rating, review, csrftoken);
    }
  }

function sendReviewData(product_id, photo_url, rating, review, csrftoken) {
  fetch('/review/create/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': 'csrfToken',
    },
    body: JSON.stringify({
      product_id: product_id,
      photo_url: photo_url,
      rating: rating,
      review: review,
    }),
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Review submitted successfully!');
      console.log(data.data);

      // Reset form fields FIRST
      const reviewForm = document.getElementById('reviewForm');
      if (reviewForm) reviewForm.reset();
      
      const ratingField = document.getElementById('rating');
      if (ratingField) ratingField.value = '';
      
      const photoPreview = document.getElementById('photoPreview');
      if (photoPreview) photoPreview.src = '';
      
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      if (photoPreviewContainer) photoPreviewContainer.style.display = 'none';

      // Close the review modal
      const reviewModal = document.getElementById('reviewModal');
      if (reviewModal) reviewModal.style.display = 'none';

      // Extract data from response
      const reviewData = data.data;
      const createdByFullname = reviewData.created_by_fullname || 'Anonymous';
      const createdAt = new Date(reviewData.created_at).toLocaleString('en-US', {
        month: 'short', 
        day: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit'
      });
      const reviewText = reviewData.review;
      const photoUrl = reviewData.photo;

      // Generate stars using rating_range and empty_range arrays from backend
      let starsHtml = '';
      
      // Add filled stars
      if (Array.isArray(reviewData.rating_range)) {
        reviewData.rating_range.forEach(() => {
          starsHtml += '⭐';
        });
      }

      // Add empty stars
      if (Array.isArray(reviewData.empty_range)) {
        reviewData.empty_range.forEach(() => {
          starsHtml += '☆';
        });
      }

      // Create new review element
      const reviewsContainer = document.getElementById('reviews-show');
      
      if (reviewsContainer) {
        const newReviewDiv = document.createElement('div');
        newReviewDiv.innerHTML = `
          <div>
            <div class="d-flex justify-content-between items-center">
              <div class="d-flex gap-2 font-bold">
                <p style="font-weight: bold; margin:0px!important;">${createdByFullname}</p>
                <div>${createdAt}</div>
              </div>
              <div>${starsHtml}</div>
            </div>
            <p class="text-gray-700 mb-2 m-auto" style="width:96%;">${reviewText}</p>
            ${photoUrl ? `<img src="${photoUrl}" alt="Review photo" class="max-w-xs rounded-md mb-2 shadow" />` : ''}
          </div>
        `;

        // Insert at the top of reviews container
        reviewsContainer.insertBefore(newReviewDiv, reviewsContainer.firstChild);
        
        console.log('Review added to DOM successfully');
      } else {
        console.error('Reviews container not found');
      }

    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Fetch error:', error);
    alert('Fetch error: ' + error);
  });
}

</script>
{% endblock %}