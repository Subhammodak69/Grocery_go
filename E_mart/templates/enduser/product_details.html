{% extends 'enduser/base.html' %}
{% load static %}
{% block title %} Product Details | GroceryGo {% endblock %}
{% block content %}
<script src="{% static 'js/enduser/product_details.js' %}"></script>
<div class="container-9 bg-white rounded">
  <div class="row g-4 w-100 m-auto">
    <!-- Product Image -->
    <div class="col-12 col-md-6">
        <span id="wishlist-{{ product.id }}" class="icon-love"
            data-product-id="{{ product.id }}" 
            onclick="toggleWishlist(this)">
            {% if product.is_in_wishlist %}
            <i class="bi bi-heart-fill" style="color:red"></i>
            {% else %}
            <i class="bi bi-heart"></i>
            {% endif %}
        </span>

        <img src="{% static product.image %}" alt="Product Image" class="img-fluid rounded" style="border:1px solid grey; border-radius:5px; padding: 40px 20px;"/>
        </div>

    <!-- Product Details -->
    <div class="col-12 col-md-6 d-flex flex-column justify-content-between">
      <div>
        <input type="hidden" id="product_id" value="{{product.id}}">
        <h1 class="h3 fw-bold mb-3 text-dark">{{product.name}}</h1>
        <div class="price-stack mb-2">
          <div class="d-flex align-items-center justify-content-between gap-2">
          <span class="original-price">₹{{ product.original_price }}/{{ product.size }} </span>
          <p class="discount-label mb-0">{{ discount|floatformat:2 }}%Off</p>
          </div>
          <span class="discounted-price">₹{{ product.price }}/{{ product.size }}</span>
        </div>
        <div class="d-flex align-items-center mb-3">
          <div class="text-warning d-flex">
            <!-- 5 star icons for review (Bootstrap doesn't have built-in SVG, so using inline SVG as is) -->
             {% if rating %}
             {% for i in rating.rated_stars%}
            <svg class="me-1" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
            </svg>
            {% endfor %}
             {% for i in rating.unrated_stars%}
            <svg width="20" height="20" fill="#d1d5db" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
            </svg>
            {% endfor %}
            {% endif %}
          </div>
          <span class="ms-2 text-muted small">({{rating.ratings}})</span>
        </div>
        <p class="text-secondary mb-4">
            {{product.description}}
        </p>
        <h6>Category:</h6>
        <p class="mb-4">
            {{product.category.name}}
        </p>
        <p class="text-secondary mb-4">
            {{product.category.description}}
        </p>
        {% if product.stock == 0%}
        <p class="text-danger fw-semibold mb-4">Out of Stock</p>
        {% elif product.stock <= 10%}
        <p class="text-warning fw-semibold mb-4">Hurry up {{product.stock}} in Stock</p>
        {% else %}
        <p class="text-success fw-semibold mb-4">In Stock</p>
        {% endif %}
      </div>
      <div class="bg-gray-200" style="display: flex; align-items: center;border:2px solid gray; width:30%;border-radius:5px;">
        <button type="button" onclick="changeQuantity(-1)" style="font-size:20px;border: none;">-</button>
        <input 
            type="number" 
            id="quantity" 
            min="1" 
            max="{{product.stock}}" 
            value="1" 
            class="form-control text-center" 
            style="border:none;" 
            readonly
        />
        <button type="button" onclick="changeQuantity(1)" style="font-size:20px;border: none;">+</button>
    </div>
        <div class="mt-4 d-flex align-items-center gap-4">
            <button class="btn btn-danger px-4"onclick="buy_now()" {% if product.stock == 0 %}disabled{% endif %}>
              <i class="bi bi-bag"></i> Buy now
            </button>
            <button class="btn btn-warning px-4" onclick="add_to_cart()" {% if product.stock == 0 %}disabled{% endif %}>
              <i class="bi bi-cart"></i>Add to Cart
            </button>
        </div>
    </div>
  </div>

  <div class="mt-5 pt-4 border-top">
    <!-- reviews & Reviews -->
    <div class="mt-4">
      <div class="d-flex justify-content-between">
        <h4>Reviews</h4>
          {% if request.user.is_authenticated %}
            <button class="btn btn-primary" onclick="openreviewmodal()">Give your's Reviews</button>
          {% endif %}
      </div>

      <!-- Review Modal -->
      <div class="review-modal" id="reviewModal" style="display:none;">
        <div>
          <form id="reviewForm" onsubmit="event.preventDefault(); create_review();">
            <input type="hidden" id="product_id" value="{{ product_item_data.product_id }}" />

            <div id="starreview">
              <svg class="me-1 star" data-value="1" width="20" height="20" fill="rgb(209, 213, 219)" viewBox="0 0 20 20">
                <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
              </svg>
              <svg class="me-1 star" data-value="1" width="20" height="20" fill="rgb(209, 213, 219)" viewBox="0 0 20 20">
                <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
              </svg>
              <svg class="me-1 star" data-value="1" width="20" height="20" fill="rgb(209, 213, 219)" viewBox="0 0 20 20">
                <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
              </svg>
              <svg class="me-1 star" data-value="1" width="20" height="20" fill="rgb(209, 213, 219)" viewBox="0 0 20 20">
                <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
              </svg>
              <svg class="me-1 star" data-value="1" width="20" height="20" fill="rgb(209, 213, 219)" viewBox="0 0 20 20">
                <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
              </svg>
            </div>

            <input type="hidden" id="rating" name="rating" />

            <div class="px-2">
              <div class="d-flex justify-content-between" style="position: relative;">
                <textarea id="review" style="border:none; background:rgb(206, 206, 206); padding:10px; width:100%;" placeholder="Write your review" required></textarea>

                <!-- Hidden file input to select photo -->
                <input type="file" id="photoInput" accept="image/*" style="display:none;" />

                <!-- Photo icon - click triggers file input -->
                <i id="photoIcon" style="right: 10px; bottom: 22%; position: absolute; font-size: 20px; cursor: pointer;" class="bi-card-image"></i>
              </div>

              <!-- Preview container -->
              <div id="photoPreviewContainer" style="margin-top: 10px; display:none;">
                <img id="photoPreview" src="" alt="Photo Preview" style="max-width: 100%; max-height: 70px; border-radius: 4px;" />
              </div>

              <button class="btn btn-primary mt-2" type="submit">Submit Review</button>
            </div>
          </form>
        </div>
      </div>
          <hr>

        <!-- Reviews List -->
      <div class="reviews-container space-y-4">
        <div id="reviews-show"></div>
      </div>
        {% if reviews %}

        {% for review in reviews %}
          <div>
            <div class="d-flex justify-content-between items-center justify-between">
              <div class=" d-flex w-100 align-items-center justify-content-between gap-2 font-bold">
                <p class="review_header" style=" font-weight:700;color:gray; margin:0px!important;">
                  <i class="bi bi-person-fill "></i>
                  {{ review.created_by|default:"Anonymous" }}
                </p>
                <div class="review_time">
                  {{ review.created_at|date:"M d, Y H:i" }}
                </div>
              </div>
            </div>
            <span class="mx-2">
              {% for i in review.colored_stars %}
                <svg class="me-1 star" fill="#f6bd00ff" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
                </svg>
              {% endfor %}
              {% for i in review.uncolored_stars %}
                <svg class="star" fill="#d1d5db" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
                </svg>
              {% endfor %}
            </span>
            <p class="text-gray-700 mb-2 m-auto" style="width:96%;">{{ review.review_text }}</p>
            {% if review.review_image %}
            <div onclick="openPhotoModal('{% static review.review_image %}')">
              <img src="{% static review.review_image %}" alt="Review photo" class="max-w-xs rounded-md mb-2 shadow" height="50px" width="50px" style="border:2px solid darkgray; margin-left:10px;" />
            </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p id ="no-review" class="text-red-600 font-semibold">No reviews found yet.</p>
    {% endif %}
  </div>
</div>
<div class="mt-5 py-4 mb-3 border-top border-bottom">
  <h2 class="h5 fw-semibold mb-3">Additional Information</h2>
  <ul class="list-unstyled text-secondary mb-0">
    <li>Delivery charges: Free shipping on orders over ₹500</li>
    <li>Exchange and Refund is available.</li>
  </ul>
</div>
  <h2 class="h5 fw-semibold">Related Products</h2>

<div class="d-flex overflow-y-scroll g-4 mx-auto mb-5 bg-light" style="padding: 10px;gap: 10px;">
  {% for product in products %}
  <div style="max-width:200px; width:100%;">
    <div class="card product-card h-100 mb-3"> 
      <span class="wishlist-icon"
            data-product-id="{{ product.id }}"
            onclick="toggleWishlist(this)">
        {% if product.is_in_wishlist %}
          <i class="bi bi-heart-fill" style="color:red"></i>
        {% else %}
          <i class="bi bi-heart"></i>
        {% endif %}
      </span>
      <img src="{% static product.image %}" class="product-img" alt="Product">
        <div class="product-info">
          <div style="height: 40px;overflow: hidden; ">
            <h5 class="product-title">{{ product.name }}</h5>
            <div class="d-flex align-items-center mb-3">
              <div class="text-warning d-flex">
                <!-- 5 star icons for review (Bootstrap doesn't have built-in SVG, so using inline SVG as is) -->
                {% if product.rating %}
                {% for i in product.rating.rated_stars%}
                <svg class="me-1" width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
                </svg>
                {% endfor %}
                {% for i in product.rating.unrated_stars%}
                <svg width="12" height="12" fill="#d1d5db" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.564-.955L10 0l2.946 5.955 6.564.955-4.755 4.635 1.123 6.545z"/>
                </svg>
                {% endfor %}
                {% endif %}
              </div>
              <span class="ms-2 text-muted small">({{product.rating.ratings}})</span>
            </div>
          </div>
          <div class="price-stack mb-2">
            <div class="d-flex align-items-center justify-content-between gap-2">
            <span class="original-price">₹{{ product.original_price }} </span>
            <p class="discount-label mb-0">{{ product.discount|floatformat:2 }}%</p>
            
            </div>
            <span class="discounted-price">₹{{ product.price }}/{{ product.size }}</span>
          </div>
          <button class="para text-center view-btn" onclick="window.location.href='/product/{{product.id}}/'">View Details-></button>
        </div>
    </div>
  </div>
  {% endfor %}
</div>
<!--Show picture-->
<div id="photo-modal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(10,12,30,0.36); align-items:center; justify-content:center;">
  <div style="max-height:300px;height:60%;max-width:500px;width: 80%; margin:auto; background:#fff; border-radius:12px; box-shadow:0 2px 24px rgba(30,30,140,.10); padding:2rem; position:relative;">
    <i onclick="closeModal()" class="bi bi-x" style="cursor:pointer; position:absolute; top:10px; right:10px; font-size:1.5rem;"></i>
    <img id="modal-photo" src="" alt="Review photo" class="max-w-xs rounded-md mb-2 shadow h-100 w-100" />
  </div>
</div>


<script>
function openPhotoModal(photoSrc) {
  const modal = document.getElementById('photo-modal');
  const modalImg = document.getElementById('modal-photo');
  modalImg.src = photoSrc;  // set the clicked image src
  modal.style.display = 'flex';  // show modal with flex for centering
}

function closeModal() {
  const modal = document.getElementById('photo-modal');
  modal.style.display = 'none';
}



  function changeQuantity(delta) {
      const input = document.getElementById('quantity');
      let currentValue = parseInt(input.value, 10);
      const maxStock = {{product.stock}};
      const minValue = 1;

      let newValue = currentValue + delta;
      if (newValue > maxStock) newValue = maxStock;
      if (newValue < minValue) newValue = minValue;

      input.value = newValue;
  }
</script>
{% endblock %}