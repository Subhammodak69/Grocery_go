{% extends 'enduser/base.html' %}
{% load static %}
{% block title %} Your Orders | Grocery_Go {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/enduser/cart.css' %}">
<style>
.orders-list { display: flex; flex-direction: column; gap: 18px;scrollbar-width: none;
    overflow: auto;
    height: 100vh;
    padding: 10px;
    background: #0c2a44;}
.order-card-horiz {
  overflow: hidden;
  max-height: 120px;
  display: flex; align-items: center; padding: 22px;
  background: #fff; border-radius: 10px; box-shadow: 0 1px 4px rgba(20,40,50,0.03);
  border: 1px solid #e0e6f0; position: relative; min-height: 100px; gap: 22px;
}
.order-card-left { display: flex; align-items: center; gap: 18px; flex: 2; min-width:0; }
.order-photo-block { display:flex; gap:2px; position:relative; width:80px; height:80px; min-width:80px; min-height:80px;}
.order-img-single { width:80px; height:80px; object-fit: contain; border-radius:7px; border:1px solid #e0e6f0; background: #f1f3f7;}
.order-img-grid { object-fit:cover; border-radius:4px; border:1px solid #e0e6f0; background: #f1f3f7;}
.order-img-grid-2, .order-img-grid-3, .order-img-grid-4 {position:absolute;}
.order-img-grid-2 {width:50%; height:100%;}
.order-img-grid-3, .order-img-grid-4 {width:50%; height:50%;}
.order-img-pos-1 {top:0;left:0;}
.order-img-pos-2 {top:0;right:0;}
.order-img-pos-3 {bottom:0;left:0;}
.order-img-pos-4 {bottom:0;right:0;}
.order-img-more-overlay {
  position: absolute; bottom: 0; right:0; width: 50%; height: 50%;
  background: rgba(22,26,30,0.70); color: #fff; font-size:1.2rem; font-weight:600; display: flex; align-items: center; justify-content:center; border-radius:0 0 4px 0;
}
.order-main-info { min-width:0;}
.order-title {font-size:17px; font-weight:600; margin-bottom:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:300px;}
.order-variant, .order-address { color: #888ea8; font-size: 13px;}
.order-card-price { font-size:18px; font-weight:500; color: #222b36; min-width:80px; text-align:right;}
.order-card-status { display:flex; align-items:center; gap:7px; min-width:150px; font-size:10px; font-weight:400;}
.order-card-status .status-dot { display:inline-block; width:13px; height:13px; margin-right:1px; border-radius:50%; background:#e74a3b;}
.order-card-status.delivered { color:#2db847;} .order-card-status.delivered .status-dot {background:#2db847;}
.order-card-status.cancelled { color:#e74a3b;} .order-card-status.cancelled .status-dot {background:#e74a3b;}
@media (max-width:700px) {
  .order-title{max-width:120px; font-size:13px;}
  .order-card-price{ font-size:15px;left: 0px;
        position: absolute;
        bottom: 2px;}
  .order-photo-block{width:54px; height:54px; min-width:54px; min-height:54px;}
  .order-img-single{width:54px; height:54px;}
}
@media (min-width:992px) {
  .orders-list{
    margin: auto;
    max-width: 80%;
  }

}

@media (max-width:992px){
  .order-card-status{
    position: absolute;
    right: 5px;
    top: 5px;
  }
  .container{
    padding:10px!important;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4 px-4" style="min-height: 100vh; margin-top:80px; background:white;">
  <div class="cart-header mb-4">
    <h2 class="cart-title"><i class="bi bi-cart-check-fill me-2"></i>Your Orders</h2>
    <p class="cart-subtitle text-gray">
      {% if orders %}{{ orders|length }} item{{ orders|length|pluralize }} in your orders
      {% else %}Your cart is empty{% endif %}
    </p>
  </div>
  {% if orders %}
    <div class="orders-list">
    {% for order in orders %}
      <div class="order-card-horiz" onclick="window.location.href = '/order/{{order.id}}/'">
        <div class="order-card-left">
          <!-- PHOTO FIELD -->
          <div class="order-photo-block">
            {# Get length once #}
            {% with order.orderitems|length as item_count %}
            {% if item_count == 1 %}
              <!-- Single image, fill -->
              <img
                src="{% if order.orderitems.0.product_details.product.image %}{% static order.orderitems.0.product_details.product.image %}{% else %}{% static 'no_image.png' %}{% endif %}"
                class="order-img-single"
                alt="Product">
            {% elif item_count == 2 %}
              {% for item in order.orderitems %}
                <img
                  src="{% if item.product_details.product.image %}{% static item.product_details.product.image %}{% else %}{% static 'no_image.png' %}{% endif %}"
                  class="order-img-grid order-img-grid-2 order-img-pos-{{forloop.counter}}"
                  alt="Product">
              {% endfor %}
            {% elif item_count == 3 %}
              {% for item in order.orderitems|slice:":2" %}
                <img
                  src="{% if item.product_details.product.image %}{% static item.product_details.product.image %}{% else %}{% static 'no_image.png' %}{% endif %}"
                  class="order-img-grid order-img-grid-2 order-img-pos-{{forloop.counter}}"
                  alt="Product">
              {% endfor %}
              <img
                src="{% if order.orderitems.2.product_details.product.image %}{% static order.orderitems.2.product_details.product.image %}{% else %}{% static 'no_image.png' %}{% endif %}"
                class="order-img-grid order-img-grid-3 order-img-pos-3"
                alt="Product">
            {% elif item_count == 4 %}
              {% for item in order.orderitems|slice:":4" %}
                <img
                  src="{% if item.product_details.product.image %}{% static item.product_details.product.image %}{% else %}{% static 'no_image.png' %}{% endif %}"
                  class="order-img-grid order-img-grid-4 order-img-pos-{{forloop.counter}}"
                  alt="Product">
              {% endfor %}
            {% elif item_count > 4 %}
              {% for item in order.orderitems|slice:":3" %}
                <img
                  src="{% if item.product_details.product.image %}{% static item.product_details.product.image %}{% else %}{% static 'no_image.png' %}{% endif %}"
                  class="order-img-grid order-img-grid-4 order-img-pos-{{forloop.counter}}"
                  alt="Product">
              {% endfor %}
                <img
                  src="{% if order.orderitems.3.product_details.product.image %}{% static order.orderitems.3.product_details.product.image %}{% else %}{% static 'no_image.png' %}{% endif %}"
                  class="order-img-grid order-img-grid-4 order-img-pos-4"
                  alt="Product">
                <div class="order-img-more-overlay">
                  +{{ item_count|add:'-4' }}
                </div>
            {% endif %}
            {% endwith %}
          </div>

          <!-- INFO FIELD -->
          <div class="order-main-info">
            <div class="order-title">
              {% for item in order.orderitems %}
              {{item.product_details.product.name}},
              {% endfor %}
            </div>
            <div class="order-address"><strong style="white-space: nowrap;">Delivery Address:</strong> <p style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">{{ order.address }}</p></div>
          </div>
        </div>
        <div class="order-card-price">
          â‚¹{{ order.total|floatformat:2 }}
        </div>
        <div class="order-card-status {% if order.status == 'Delivered' %}delivered{% elif order.status == 'Cancelled' %}cancelled{% endif %}">
          <span class="status-dot"></span>
          {{ order.status }} on {{ order.updated_at|date:"M d, Y" }}
        </div>
      </div>
    {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info mt-4">You have no orders yet.</div>
  {% endif %}
</div>
{% endblock %}
